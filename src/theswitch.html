<!DOCTYPE html>
<html lang="en">
<head>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Hide body by default to prevent content flashing */
        body { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    </style>
    <script>
        // 1. Config
        const GATEKEEPER_URL = 'https://mpxayhidmnzykuibpfin.supabase.co';
        const GATEKEEPER_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1weGF5aGlkbW56eWt1aWJwZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTg4NDIsImV4cCI6MjA4MjQ5NDg0Mn0.LbOySRbVBvH5UpHWMbO938p5tVUdGtAYnSMsW3Vi2e8';
        const supabaseGatekeeper = window.supabase.createClient(GATEKEEPER_URL, GATEKEEPER_KEY);

        // 2. Auth Check (The "Hard Check")
        async function checkAuth() {
            try {
                // getUser() contacts the server to verify the user still exists
                const { data: { user }, error } = await supabaseGatekeeper.auth.getUser();
                
                if (error || !user) {
                    // User is deleted or token is invalid -> FORCE LOGOUT
                    console.warn("User validation failed. Redirecting...");
                    await supabaseGatekeeper.auth.signOut(); // Clear local session
                    localStorage.clear(); // Nuke any leftovers
                    window.location.replace("../index.html"); 
                } else {
                    // Logged in & Valid -> Reveal Page
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', showPage);
                    } else {
                        showPage();
                    }
                }
            } catch (error) {
                console.error("Auth system error:", error);
                window.location.replace("../index.html");
            }
        }

        function showPage() {
            document.body.style.opacity = "1";
            document.body.style.pointerEvents = "auto";
        }

        checkAuth();
    </script>
    

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Hide body by default to prevent content flashing */
        body { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    </style>
    <script>
        // 1. Config
        const GATEKEEPER_URL = 'https://mpxayhidmnzykuibpfin.supabase.co';
        const GATEKEEPER_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1weGF5aGlkbW56eWt1aWJwZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTg4NDIsImV4cCI6MjA4MjQ5NDg0Mn0.LbOySRbVBvH5UpHWMbO938p5tVUdGtAYnSMsW3Vi2e8';
        
        // Use a unique variable name to avoid conflicts
        const supabaseGatekeeper = window.supabase.createClient(GATEKEEPER_URL, GATEKEEPER_KEY);

        // 2. Auth Check
        async function checkAuth() {
            try {
                const { data: { session } } = await supabaseGatekeeper.auth.getSession();
                
                if (!session) {
                    // Not logged in? Redirect to Main Hub
                    // Adjust this path if your files are in sub-sub-folders
                    window.location.replace("../index.html"); 
                } else {
                    // Logged in? Wait for body to exist, then reveal
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', showPage);
                    } else {
                        showPage();
                    }
                }
            } catch (error) {
                console.error("Auth check failed:", error);
                window.location.replace("../index.html"); // Fail safe
            }
        }

        function showPage() {
            document.body.style.opacity = "1";
            document.body.style.pointerEvents = "auto";
        }

        checkAuth();
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantForge | The Switch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Glass Effect */
        .glass-card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Task Boxes */
        .task-box {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.3;
            transform: scale(0.98);
            border: 2px solid rgba(255, 255, 255, 0.05);
            filter: grayscale(0.8);
            background: rgba(30, 41, 59, 0.4);
        }
        
        .task-box.active {
            opacity: 1;
            transform: scale(1.02);
            border-color: #eab308;
            background: rgba(234, 179, 8, 0.05);
            box-shadow: 0 0 30px rgba(234, 179, 8, 0.15);
            filter: grayscale(0);
            z-index: 10;
        }

        /* Input Buttons */
        .input-btn {
            transition: all 0.1s;
            border-bottom: 4px solid rgba(255,255,255,0.1);
        }
        .input-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0px;
        }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #eab308; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        /* Animation */
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.2); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(239, 68, 68, 0.2); } 100% { background-color: transparent; } }
        .flash-success { animation: flash-green 0.3s ease-out; }
        .flash-error { animation: flash-red 0.3s ease-out; }
    </style>

    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#020617">
    <link rel="apple-touch-icon" href="../icon-192.png">
    
</head>
<body class="min-h-screen selection:bg-yellow-500/30 p-4 lg:p-10 flex flex-col">

    <div id="app" class="max-w-7xl mx-auto w-full animate-in fade-in duration-500 flex-1 flex flex-col">
        
        <div class="mb-8 flex items-center justify-between border-b border-white/10 pb-6">
            <a href="zap-n-suite.html" class="flex items-center gap-2 text-xs font-bold text-slate-500 hover:text-white transition-colors uppercase tracking-widest bg-slate-900/50 px-4 py-2 rounded-full border border-slate-800 hover:border-slate-600">
                <span>‚Üê</span> Zap-N Suite
            </a>
            
            <div class="flex items-center gap-8">
                <div class="text-right">
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Time</div>
                    <div class="text-xl font-black text-white mono" id="timer-display">00:00</div>
                </div>
                
                <div class="h-8 w-px bg-white/10"></div>

                <div class="text-right">
                    <div class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest">Score</div>
                    <div class="text-xl font-black text-white mono" id="score-display">0</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="glass-card p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-6 opacity-5">
                        <svg class="w-32 h-32 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                    </div>

                    <h2 class="text-xl font-extrabold text-white tracking-tight mb-6">PROTOCOL SETUP</h2>

                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold uppercase text-slate-500 mb-2">
                                <span>Session Duration</span>
                                <span id="label-dur" class="text-yellow-400">60s</span>
                            </div>
                            <input type="range" id="input-dur" min="30" max="120" step="30" value="60" oninput="updateSettingsUI()" class="w-full">
                        </div>

                        <div class="p-4 bg-slate-800/50 rounded-xl border border-white/5 space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-yellow-600/20 border border-yellow-500/50 flex items-center justify-center text-yellow-500 font-bold">1</div>
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Top Box Active</div>
                                    <div class="text-xs text-white">Is the Math Result <strong class="text-yellow-400">ODD</strong>?</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-yellow-600/20 border border-yellow-500/50 flex items-center justify-center text-yellow-500 font-bold">2</div>
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Bottom Box Active</div>
                                    <div class="text-xs text-white">Are Arrow Sets <strong class="text-yellow-400">IDENTICAL</strong>?</div>
                                </div>
                            </div>
                        </div>

                        <button onclick="startGame()" id="btn-start" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-4 rounded-xl font-bold uppercase tracking-widest text-sm shadow-lg shadow-yellow-900/20 transition-all active:scale-95">
                            Initialize Session
                        </button>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Switching Cost (ms)</h3>
                    </div>
                    <div class="h-32 w-full">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 flex flex-col">
                <div id="game-stage" class="glass-card flex-1 rounded-[3rem] p-8 flex flex-col relative border border-slate-700/50 transition-colors duration-200 overflow-hidden">
                    
                    <div class="absolute top-0 left-0 right-0 h-1 bg-slate-800">
                        <div id="timer-bar" class="h-full bg-yellow-500 w-full transition-all duration-1000 ease-linear"></div>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center gap-6 w-full max-w-4xl mx-auto">
                        
                        <div id="box-top" class="task-box w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]">
                            <div class="w-1/2 border-r border-white/5 pr-4 flex items-center justify-center">
                                <span class="math-display text-4xl lg:text-5xl font-black text-white mono tracking-wider"></span>
                            </div>
                            <div class="w-1/2 pl-4 flex items-center justify-center">
                                <div class="arrow-set-1 flex items-center justify-center gap-1 lg:gap-3"></div>
                                <div class="w-4"></div> <div class="arrow-set-2 flex items-center justify-center gap-1 lg:gap-3"></div>
                            </div>
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-900 px-3 py-1 rounded border border-white/10 text-[10px] text-yellow-500 font-bold uppercase tracking-widest">Math: Is Odd?</div>
                        </div>

                        <div id="box-bottom" class="task-box w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]">
                            <div class="w-1/2 border-r border-white/5 pr-4 flex items-center justify-center">
                                <span class="math-display text-4xl lg:text-5xl font-black text-white mono tracking-wider"></span>
                            </div>
                            <div class="w-1/2 pl-4 flex items-center justify-center">
                                <div class="arrow-set-1 flex items-center justify-center gap-1 lg:gap-3"></div>
                                <div class="w-4"></div> <div class="arrow-set-2 flex items-center justify-center gap-1 lg:gap-3"></div>
                            </div>
                            <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-slate-900 px-3 py-1 rounded border border-white/10 text-[10px] text-yellow-500 font-bold uppercase tracking-widest">Arrows: Match?</div>
                        </div>

                    </div>

                    <div class="mt-8 grid grid-cols-2 gap-6 max-w-xl mx-auto w-full">
                        <button onclick="handleInput(false)" class="input-btn bg-slate-800 hover:bg-slate-700 text-white py-5 rounded-2xl border border-white/10 group">
                            <div class="text-2xl font-black mb-1 group-hover:text-red-400 transition-colors">NO</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest">Even / Different</div>
                        </button>
                        <button onclick="handleInput(true)" class="input-btn bg-slate-800 hover:bg-slate-700 text-white py-5 rounded-2xl border border-white/10 group">
                            <div class="text-2xl font-black mb-1 group-hover:text-green-400 transition-colors">YES</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest">Odd / Identical</div>
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG & STATE ---
        let config = { duration: 60 };
        let session = { active: false, score: 0, total: 0, latencies: [], startTime: 0, timer: null };
        let currentTask = null; // 'math' (top) or 'arrow' (bottom)
        let currentAnswer = null; // true (yes) or false (no)
        let roundStartTime = 0;
        let chart;

        // UPDATED: Arrow directions are just keys now
        const ARROW_DIRS = ['UP', 'RIGHT', 'DOWN', 'LEFT'];

        // --- INIT ---
        window.onload = () => {
            updateSettingsUI();
            initChart();
            
            document.addEventListener('keydown', (e) => {
                if(!session.active) return;
                if(e.key === 'ArrowLeft') handleInput(false);
                if(e.key === 'ArrowRight') handleInput(true);
            });
        };

        function updateSettingsUI() {
            config.duration = parseInt(document.getElementById('input-dur').value);
            document.getElementById('label-dur').innerText = `${config.duration}s`;
        }

        // --- RENDER HELPERS ---
        // Generates an SVG string for a specific direction
        // This ensures every arrow has the exact same path and thickness
        function getArrowSVG(dir) {
            let rotationClass = '';
            if (dir === 'UP') rotationClass = 'rotate-0';
            if (dir === 'RIGHT') rotationClass = 'rotate-90';
            if (dir === 'DOWN') rotationClass = 'rotate-180';
            if (dir === 'LEFT') rotationClass = '-rotate-90';

            return `
                <div class="${rotationClass} w-6 h-6 lg:w-8 lg:h-8 flex items-center justify-center transform transition-none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full text-white">
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    </svg>
                </div>
            `;
        }

        // --- GAME ENGINE ---
        function startGame() {
            if(session.active) return;
            session = { active: true, score: 0, total: 0, latencies: [], startTime: Date.now(), timer: null };
            document.getElementById('score-display').innerText = "0";
            document.getElementById('btn-start').innerText = "Running...";
            document.getElementById('btn-start').classList.add('opacity-50', 'cursor-not-allowed');
            
            resetChart();

            let timeLeft = config.duration;
            document.getElementById('timer-bar').style.width = '100%';
            session.timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-bar').style.width = `${(timeLeft / config.duration) * 100}%`;
                if(timeLeft <= 0) endGame();
            }, 1000);

            nextRound();
        }

        function nextRound() {
            if(!session.active) return;

            // 1. Pick Active Task
            currentTask = Math.random() > 0.5 ? 'top' : 'bottom';
            
            // 2. Generate Content
            
            // MATH GENERATION
            const n1 = Math.floor(Math.random() * 20) + 1;
            const n2 = Math.floor(Math.random() * 20) + 1;
            const op = Math.random() > 0.5 ? '+' : '-';
            const v1 = (op === '-' && n2 > n1) ? n2 : n1;
            const v2 = (op === '-' && n2 > n1) ? n1 : n2;
            const mathStr = `${v1} ${op} ${v2}`;
            const mathRes = op === '+' ? v1 + v2 : v1 - v2;
            const isOdd = (mathRes % 2 !== 0);

            // ARROW GENERATION (Using new Directions array)
            let row1 = Array.from({length: 4}, () => ARROW_DIRS[Math.floor(Math.random()*4)]);
            let isIdentical = Math.random() > 0.5;
            let row2 = [...row1];
            
            if (!isIdentical) {
                const idx = Math.floor(Math.random() * 4);
                let newArr = row1[idx];
                while(newArr === row1[idx]) newArr = ARROW_DIRS[Math.floor(Math.random()*4)];
                row2[idx] = newArr;
            }

            // Convert directions to SVG HTML
            const arrows1HTML = row1.map(d => getArrowSVG(d)).join('');
            const arrows2HTML = row2.map(d => getArrowSVG(d)).join('');

            // 3. Update DOM
            const topBox = document.getElementById('box-top');
            const botBox = document.getElementById('box-bottom');

            // Set content for both boxes
            document.querySelectorAll('.math-display').forEach(el => el.innerText = mathStr);
            // Use innerHTML for SVG injection
            document.querySelectorAll('.arrow-set-1').forEach(el => el.innerHTML = arrows1HTML);
            document.querySelectorAll('.arrow-set-2').forEach(el => el.innerHTML = arrows2HTML);

            // 4. Highlight Active Box
            if (currentTask === 'top') {
                topBox.className = "task-box active w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]";
                botBox.className = "task-box w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]";
                currentAnswer = isOdd;
            } else {
                topBox.className = "task-box w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]";
                botBox.className = "task-box active w-full rounded-3xl p-6 flex items-center justify-between relative min-h-[140px]";
                currentAnswer = isIdentical;
            }

            roundStartTime = performance.now();
        }

        function handleInput(choice) {
            if(!session.active) return;

            const latency = performance.now() - roundStartTime;
            session.total++;
            
            const isCorrect = choice === currentAnswer;
            const stage = document.getElementById('game-stage');

            if(isCorrect) {
                session.score++;
                document.getElementById('score-display').innerText = session.score;
                session.latencies.push(latency);
                stage.classList.add('flash-success');
                setTimeout(() => stage.classList.remove('flash-success'), 200);
            } else {
                stage.classList.add('flash-error');
                setTimeout(() => stage.classList.remove('flash-error'), 200);
            }

            updateChart(latency);
            nextRound();
        }

        function endGame() {
            session.active = false;
            clearInterval(session.timer);
            document.getElementById('btn-start').innerText = "Initialize Session";
            document.getElementById('btn-start').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- CHART ---
        function initChart() {
            const ctx = document.getElementById('perfChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        borderColor: '#eab308',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }
                    },
                    animation: false
                }
            });
        }

        function resetChart() {
            if(!chart) return;
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();
        }

        function updateChart(val) {
            if(!chart) return;
            chart.data.labels.push('');
            chart.data.datasets[0].data.push(val);
            if(chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../sw.js')
                    .then(reg => console.log('SW registered!', reg.scope))
                    .catch(err => console.log('SW failed:', err));
            });
        }
    </script>
    
</body>
</html>